<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Chaves | SENAI HUB</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            /* Cores SENAI/Primary */
            --senai-blue: #007bff;
            --senai-green: #28a745;
            --edit-color: #ff9800;
            --footer-height: 50px;
        }
        
        /* Adaptação de cor de fundo da página */
        body { 
            background-color: #f8f9fa; /* Bootstrap light gray */
            min-height: 100vh;
            padding-bottom: var(--footer-height);
        }

        /* Classes para Modo Escuro (Dark Mode) */
        /* ... outros estilos .dark-mode ... */
        
        .dark-mode .table, 
        .dark-mode .table th, 
        .dark-mode .table td {
            color: var(--bs-body-color) !important; /* Força o texto da tabela a usar a cor clara do dark mode */
            border-color: #495057 !important; /* Mantém as bordas visíveis */
        }
        
        /* ... o restante dos seus estilos .dark-mode ... */
       .dark-mode {
            --bs-body-bg: #212529; /* Dark Gray */
            --bs-body-color: #f8f9fa; /* Light Text */
            --bs-card-bg: #2b3035; /* Slightly lighter dark card */
            --bs-secondary-bg: #495057; /* For table headers/stripes */
        }
        .dark-mode body {
            background-color: var(--bs-body-bg) !important;
            color: var(--bs-body-color) !important;
        }
        .dark-mode .navbar, .dark-mode .card, .dark-mode .modal-content {
            background-color: var(--bs-card-bg) !important;
            color: var(--bs-body-color) !important;
            border-color: #495057 !important;
        }
        .dark-mode .table, .dark-mode .form-control {
            color: var(--bs-body-color);
            background-color: var(--bs-card-bg);
            border-color: #495057;
        }
        .dark-mode .form-control:focus {
            border-color: var(--senai-blue);
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
        }
        .dark-mode .table th {
             background-color: var(--senai-blue) !important;
        }
        .dark-mode .footer {
            background-color: #0056b3 !important; /* Darker blue footer */
        }
        
        /* Estilos do Rodapé (Footer) - Adaptado para fixed-bottom do Bootstrap */
        .footer { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            height: var(--footer-height); 
            background: var(--senai-blue); 
            width: 100%; 
            color: white; 
            text-align: center; 
            line-height: var(--footer-height); 
            z-index: 10;
        }
    </style>
</head>
<body id="body">
    
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm border-bottom border-4" style="border-color: var(--senai-blue) !important;">
        <div class="container-fluid px-4">
            <div class="d-flex align-items-center">
                <img src="SENAI HUB - Nova Marca-01.png" alt="SENAI HUB" class="me-3" style="max-height: 70px;">
                <h1 class="navbar-brand mb-0 h1 fs-2" style="color: var(--senai-blue); font-weight: 700;">
                    CONTROLE DE CHAVES SENAI HUB
                </h1>
            </div>

            <button id="darkModeToggle" class="btn btn-outline-secondary" onclick="toggleDarkMode()" title="Alternar Modo Escuro">
                <i class="bi bi-moon-fill"></i>
            </button>
        </div>
    </nav>

    <div class="container my-4">
        
        <div class="card shadow mb-4">
            <div class="card-body">
                <h2 class="card-title h4 pb-2 border-bottom" style="color: var(--senai-blue);">Cadastrar Nova Chave</h2>
                <form id="formCadastroChave">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="nomeChave" class="form-label fw-bold">Nome da Chave:</label>
                            <input type="text" id="nomeChave" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label for="localizacao" class="form-label fw-bold">Localização:</label>
                            <input type="text" id="localizacao" class="form-control" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success mt-3">
                        <i class="bi bi-plus-circle me-1"></i> Cadastrar
                    </button>
                </form>
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-body">
                <h2 class="card-title h4 pb-2 border-bottom" style="color: var(--senai-blue);">Emitir Relatório</h2>
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label for="dataInicio" class="form-label fw-bold">Data Início:</label>
                        <input type="date" id="dataInicio" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label for="dataFim" class="form-label fw-bold">Data Fim:</label>
                        <input type="date" id="dataFim" class="form-control">
                    </div>
                    <div class="col-md-4 d-flex justify-content-end">
                        <button class="btn btn-primary me-2" onclick="emitirRelatorioCSV()">
                            <i class="bi bi-file-earmark-spreadsheet me-1"></i> Gerar CSV
                        </button>
                        <button class="btn btn-danger me-2" onclick="emitirRelatorioPDF()">
                            <i class="bi bi-file-pdf me-1"></i> Gerar PDF
                        </button>
                        <button class="btn" style="background-color: var(--edit-color); color: white;" onclick="testarRelatorio()">
                            <i class="bi bi-journal-check me-1"></i> Testar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow">
            <div class="card-body">
                <h2 class="card-title h4 pb-2 border-bottom" style="color: var(--senai-blue);">
                    Status das Chaves (Total: <span id="totalChaves">0</span>)
                </h2>
                
                <div class="mb-3">
                    <label for="buscaChave" class="form-label fw-bold">Buscar:</label>
                    <input type="text" id="buscaChave" onkeyup="filtrarChaves()" class="form-control" placeholder="Digite o ambiente, localização ou responsável...">
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tabelaChaves">
                        <thead class="table-primary">
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Localização</th>
                                <th>Status</th>
                                <th>Retirada por</th>
                                <th>Data Retirada</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div class="modal fade" id="modalControle" tabindex="-1" aria-labelledby="modalControleLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitulo"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="formControle">
                    <div class="modal-body">
                        <input type="hidden" id="controleChaveId">
                        <input type="hidden" id="controleAcao">
                        <div class="mb-3" id="grupoRetiradaPor">
                            <label for="retiradaPor" class="form-label fw-bold">Nome de quem Retirou:</label>
                            <input type="text" id="retiradaPor" class="form-control">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn" id="btnAcaoModal"></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalEdicao" tabindex="-1" aria-labelledby="modalEdicaoLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Chave: <span id="edicaoNomeAtual" class="fw-bold"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="formEdicao">
                    <div class="modal-body">
                        <input type="hidden" id="edicaoChaveId">
                        <div class="mb-3">
                            <label for="edicaoNomeChave" class="form-label fw-bold">Novo Nome:</label>
                            <input type="text" id="edicaoNomeChave" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="edicaoLocalizacao" class="form-label fw-bold">Nova Localização:</label>
                            <input type="text" id="edicaoLocalizacao" class="form-control" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn" style="background-color: var(--edit-color); color: white;">
                            <i class="bi bi-save me-1"></i> Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="footer">Desenvolvido por <strong>Joelson M. Mendes</strong> | SENAI HUB Inovação e Tecnologia</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        const STORAGE_KEY = 'controleChavesDB';
        const HISTORICO_KEY = 'controleChavesHistorico';
        const DARK_MODE_KEY = 'darkModeEnabled';
        
        // --- FUNÇÕES DE MODO ESCURO (Adaptadas para Bootstrap) ---
        function toggleDarkMode() {
            const body = document.getElementById('body');
            const isDarkMode = body.classList.toggle('dark-mode');
            localStorage.setItem(DARK_MODE_KEY, isDarkMode);

            // Atualiza o ícone do botão
            const icon = document.querySelector('#darkModeToggle i');
            icon.className = isDarkMode ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
        }

        function aplicarDarkModeInicial() {
            const body = document.getElementById('body');
            const isDarkModeSaved = localStorage.getItem(DARK_MODE_KEY);
            const icon = document.querySelector('#darkModeToggle i');
            
            if (isDarkModeSaved === 'true') {
                body.classList.add('dark-mode');
                icon.className = 'bi bi-sun-fill';
            } else {
                icon.className = 'bi bi-moon-fill';
            }
        }
        // --------------------------------------------------------

        // Inicializar dados de exemplo se não existirem
        function inicializarDados() {
            let chaves = carregarChaves();
            if (chaves.length === 0) {
                const chavesExemplo = [
                    { id: 1, nome: "Sala de Reunião A", localizacao: "1º Andar", status: "Disponível", retiradaPor: null, dataRetirada: null },
                    { id: 2, nome: "Laboratório de Informática", localizacao: "2º Andar", status: "Disponível", retiradaPor: null, dataRetirada: null },
                    { id: 3, nome: "Almoxarifado", localizacao: "Térreo", status: "Disponível", retiradaPor: null, dataRetirada: null }
                ];
                salvarChaves(chavesExemplo);
                console.log("Dados de exemplo criados:", chavesExemplo);
            }
            
            let historico = carregarHistorico();
            if (historico.length === 0) {
                const agora = new Date();
                const historicoExemplo = [
                    {
                        id: 1,
                        nome: "Sala de Reunião A",
                        colaborador: "João Silva",
                        acao: "Retirada",
                        data: new Date(agora.getTime() - 2 * 24 * 60 * 60 * 1000).toLocaleString('pt-BR'),
                        timestamp: agora.getTime() - 2 * 24 * 60 * 60 * 1000
                    },
                    {
                        id: 1,
                        nome: "Sala de Reunião A",
                        colaborador: "João Silva",
                        acao: "Devolução",
                        data: new Date(agora.getTime() - 1 * 24 * 60 * 60 * 1000).toLocaleString('pt-BR'),
                        timestamp: agora.getTime() - 1 * 24 * 60 * 60 * 1000
                    }
                ];
                localStorage.setItem(HISTORICO_KEY, JSON.stringify(historicoExemplo));
                console.log("Histórico de exemplo criado:", historicoExemplo);
            }
        }

        function carregarChaves() {  
            try {
                const dados = localStorage.getItem(STORAGE_KEY);
                return dados ? JSON.parse(dados) : [];
            } catch (e) {
                console.error("Erro ao carregar chaves:", e);
                return [];
            }
        }
        
        function salvarChaves(chaves) {  
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(chaves));
                console.log("Chaves salvas:", chaves);
            } catch (e) {
                console.error("Erro ao salvar chaves:", e);
            }
        }
        
        function carregarHistorico() {  
            try {
                const dados = localStorage.getItem(HISTORICO_KEY);
                return dados ? JSON.parse(dados) : [];
            } catch (e) {
                console.error("Erro ao carregar histórico:", e);
                return [];
            }
        }
        
        function salvarHistorico(evento) {  
            try {
                let h = carregarHistorico();  
                h.push(evento);  
                localStorage.setItem(HISTORICO_KEY, JSON.stringify(h));
                console.log("Histórico salvo:", evento);
                console.log("Total de registros no histórico:", h.length);
            } catch (e) {
                console.error("Erro ao salvar histórico:", e);
            }
        }

        function renderizarTabela(chaves = carregarChaves()) {
            const tbody = document.querySelector('#tabelaChaves tbody');  
            tbody.innerHTML = '';
            document.getElementById('totalChaves').textContent = chaves.length;
            chaves.sort((a,b) => a.id - b.id);
            
            chaves.forEach(chave => {
                const tr = document.createElement('tr');
                
                // Adaptação de Status para Badges (crachás) do Bootstrap
                let statusBadge;
                if (chave.status === 'Disponível') {
                    statusBadge = `<span class="badge text-bg-success">${chave.status}</span>`;
                } else {
                    statusBadge = `<span class="badge text-bg-danger">${chave.status}</span>`;
                }
                
                const actionButton = chave.status === 'Disponível'
                    ? `<button class="btn btn-primary btn-sm" onclick="abrirModalBootstrap(${chave.id}, 'retirar')"><i class="bi bi-box-arrow-right"></i> Retirar</button>`
                    : `<button class="btn btn-danger btn-sm" onclick="abrirModalBootstrap(${chave.id}, 'devolver')"><i class="bi bi-box-arrow-left"></i> Devolver</button>`;
                    
                const editButton = `<button class="btn btn-sm text-white ms-1" style="background-color: var(--edit-color);" onclick="abrirModalEdicaoBootstrap(${chave.id})"><i class="bi bi-pencil-square"></i> Editar</button>`;
                
                tr.innerHTML = `
                    <td>${chave.id}</td>
                    <td>${chave.nome}</td>
                    <td>${chave.localizacao}</td>
                    <td>${statusBadge}</td>
                    <td>${chave.retiradaPor || '—'}</td>
                    <td>${chave.dataRetirada || '—'}</td>
                    <td>${actionButton} ${editButton}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Cadastro
        document.getElementById('formCadastroChave').addEventListener('submit', e => {
            e.preventDefault();
            const nome = document.getElementById('nomeChave').value.trim();
            const loc = document.getElementById('localizacao').value.trim();
            
            if (!nome || !loc) {
                alert("Preencha todos os campos");
                return;
            }
            
            let chaves = carregarChaves();
            let maxId = chaves.length ? Math.max(...chaves.map(c => c.id)) : 0;
            
            const novaChave = {
                id: maxId + 1,
                nome,
                localizacao: loc,
                status: "Disponível",
                retiradaPor: null,
                dataRetirada: null
            };
            
            chaves.push(novaChave);
            salvarChaves(chaves);  
            renderizarTabela(chaves);  
            e.target.reset();
            alert("Chave cadastrada com sucesso!");
        });

        // --- ADAPTAÇÃO DAS FUNÇÕES DE MODAL PARA O BOOTSTRAP ---
        
        // Inicializa as instâncias dos modais do Bootstrap
        const modalControleEl = document.getElementById('modalControle');
        const bsModalControle = new bootstrap.Modal(modalControleEl, {});
        
        const modalEdicaoEl = document.getElementById('modalEdicao');
        const bsModalEdicao = new bootstrap.Modal(modalEdicaoEl, {});
        
        function abrirModalBootstrap(id, acao) {
            const chave = carregarChaves().find(c => c.id === id);  
            if (!chave) return;
            
            document.getElementById('controleChaveId').value = id;
            document.getElementById('controleAcao').value = acao;
            document.getElementById('retiradaPor').value = ''; 
            
            const titulo = document.getElementById('modalTitulo');
            const grupo = document.getElementById('grupoRetiradaPor');
            const btn = document.getElementById('btnAcaoModal');
            
            if (acao === 'retirar') {  
                titulo.textContent = `Retirar: ${chave.nome}`;  
                grupo.style.display = 'block';  
                btn.textContent = 'Confirmar Retirada';  
                btn.className = 'btn btn-primary';  
            } else {  
                titulo.textContent = `Devolver: ${chave.nome}`;  
                grupo.style.display = 'none';  
                btn.textContent = 'Confirmar Devolução';  
                btn.className = 'btn btn-danger';  
            }
            
            bsModalControle.show(); // Exibe o modal
        }

        document.getElementById('formControle').addEventListener('submit', e => {
            e.preventDefault();
            const id = parseInt(document.getElementById('controleChaveId').value);
            const acao = document.getElementById('controleAcao').value;
            let chaves = carregarChaves();
            let idx = chaves.findIndex(c => c.id === id);
            
            if (idx > -1) {
                let agora = new Date();
                let dataFormatada = agora.toLocaleString('pt-BR');
                
                if (acao === 'retirar') {
                    const retiradaPor = document.getElementById('retiradaPor').value.trim();
                    if (!retiradaPor) {
                        alert("Informe quem retirou!");
                        return;
                    }
                    
                    chaves[idx].status = 'Emprestado';  
                    chaves[idx].retiradaPor = retiradaPor;  
                    chaves[idx].dataRetirada = dataFormatada;
                    
                    const evento = { id: chaves[idx].id, nome: chaves[idx].nome, colaborador: retiradaPor, acao: "Retirada", data: dataFormatada, timestamp: agora.getTime() };
                    salvarHistorico(evento);
                    
                } else {
                    let resp = chaves[idx].retiradaPor || "Não informado";
                    
                    const evento = { id: chaves[idx].id, nome: chaves[idx].nome, colaborador: resp, acao: "Devolução", data: dataFormatada, timestamp: agora.getTime() };
                    salvarHistorico(evento);
                    
                    chaves[idx].status = 'Disponível';  
                    chaves[idx].retiradaPor = null;  
                    chaves[idx].dataRetirada = null;
                }
                
                salvarChaves(chaves);  
                renderizarTabela(chaves);  
                bsModalControle.hide(); // Oculta o modal
                alert(`Chave ${acao === 'retirar' ? 'retirada' : 'devolvida'} com sucesso!`);
            }
        });

        function abrirModalEdicaoBootstrap(id) {
            const chave = carregarChaves().find(c => c.id === id);  
            if (!chave) return;
            
            document.getElementById('edicaoChaveId').value = id;
            document.getElementById('edicaoNomeAtual').textContent = chave.nome;
            document.getElementById('edicaoNomeChave').value = chave.nome;
            document.getElementById('edicaoLocalizacao').value = chave.localizacao;
            
            bsModalEdicao.show(); // Exibe o modal
        }
        
        document.getElementById('formEdicao').addEventListener('submit', e => {
            e.preventDefault();
            const id = parseInt(document.getElementById('edicaoChaveId').value);
            const novoNome = document.getElementById('edicaoNomeChave').value.trim();
            const novaLoc = document.getElementById('edicaoLocalizacao').value.trim();
            
            let chaves = carregarChaves();
            let idx = chaves.findIndex(c => c.id === id);
            
            if (idx > -1) {  
                chaves[idx].nome = novoNome;  
                chaves[idx].localizacao = novaLoc;  
                salvarChaves(chaves);  
                renderizarTabela(chaves);  
                bsModalEdicao.hide(); // Oculta o modal
                alert("Chave editada com sucesso!");
            }
        });
        
        // Não precisamos mais da função fecharModal('id') customizada, o Bootstrap cuida disso.
        // ------------------------------------------------------------------------

        // Busca (Mantida, usa input do Bootstrap)
        function filtrarChaves() {
            const f = document.getElementById('buscaChave').value.toUpperCase();
            const chaves = carregarChaves().filter(c => 
                c.nome.toUpperCase().includes(f) || 
                c.localizacao.toUpperCase().includes(f) || 
                (c.retiradaPor && c.retiradaPor.toUpperCase().includes(f))
            );
            renderizarTabela(chaves);
        }

        // Função para converter data string para Date object (Mantida)
        function parseDataString(dataString) {
            const partes = dataString.split(' ');
            const dataPart = partes[0].split('/');
            const horaPart = partes[1] ? partes[1].split(':') : ['00', '00', '00'];
            
            return new Date(
                parseInt(dataPart[2]), 
                parseInt(dataPart[1]) - 1, 
                parseInt(dataPart[0]), 
                parseInt(horaPart[0]), 
                parseInt(horaPart[1]), 
                parseInt(horaPart[2])
            );
        }

        // Relatórios (Mantidas, usam dados filtrados)
        function emitirRelatorioCSV() {
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            
            if (!dataInicio || !dataFim) {
                alert("Selecione as datas de início e fim para gerar o relatório");
                return;
            }
            
            const inicio = new Date(dataInicio + 'T00:00:00');
            const fim = new Date(dataFim + 'T23:59:59');
            
            const historico = carregarHistorico().filter(h => {
                const dataEvento = h.timestamp ? new Date(h.timestamp) : parseDataString(h.data);
                return dataEvento >= inicio && dataEvento <= fim;
            });
            
            if (!historico.length) {
                alert("Nenhum registro encontrado no período selecionado.");
                return;
            }
            
            let csv = "ID;Nome;Colaborador;Ação;Data\n";  
            historico.forEach(h => {
                csv += `${h.id};${h.nome};${h.colaborador};${h.acao};${h.data}\n`;
            });
            
            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `Relatorio_Chaves_${inicio.toLocaleDateString('pt-BR')}_${fim.toLocaleDateString('pt-BR')}.csv`;
            a.click();
        }
        
        function emitirRelatorioPDF() {
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            
            if (!dataInicio || !dataFim) {
                alert("Selecione as datas de início e fim para gerar o relatório");
                return;
            }
            
            const inicio = new Date(dataInicio + 'T00:00:00');
            const fim = new Date(dataFim + 'T23:59:59');
            
            const historico = carregarHistorico().filter(h => {
                const dataEvento = h.timestamp ? new Date(h.timestamp) : parseDataString(h.data);
                return dataEvento >= inicio && dataEvento <= fim;
            });
            
            if (!historico.length) {
                alert("Nenhum registro encontrado no período selecionado.");
                return;
            }
            
            const { jsPDF } = window.jspdf;  
            const doc = new jsPDF();
            doc.text("Relatório de Histórico de Chaves", 14, 15);
            doc.text(`Período: ${inicio.toLocaleDateString('pt-BR')} a ${fim.toLocaleDateString('pt-BR')}`, 14, 25);
            
            const rows = historico.map(h => [h.id, h.nome, h.colaborador, h.acao, h.data]);
            doc.autoTable({
                head: [["ID", "Nome", "Colaborador", "Ação", "Data"]],
                body: rows,
                startY: 35
            });
            
            doc.save(`Relatorio_Chaves_${inicio.toLocaleDateString('pt-BR')}_${fim.toLocaleDateString('pt-BR')}.pdf`);
        }

        function testarRelatorio() {
            const historico = carregarHistorico();
            console.log("Todo o histórico:", historico);
            
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            
            if (!dataInicio || !dataFim) {
                alert("Selecione as datas primeiro");
                return;
            }
            
            const inicio = new Date(dataInicio + 'T00:00:00');
            const fim = new Date(dataFim + 'T23:59:59');
            
            const historicoFiltrado = historico.filter(h => {
                const dataEvento = h.timestamp ? new Date(h.timestamp) : parseDataString(h.data);
                return dataEvento >= inicio && dataEvento <= fim;
            });
            
            console.log("Histórico filtrado:", historicoFiltrado);
            alert(`Encontrados ${historicoFiltrado.length} registros no período selecionado. Verifique o console para detalhes.`);
        }

        function verificarDados() {
            console.log("Chaves:", carregarChaves());
            console.log("Histórico:", carregarHistorico());
        }

        // Inicializar a aplicação
        window.onload = () => {
            aplicarDarkModeInicial(); // Aplica a preferência de modo escuro

            inicializarDados();
            renderizarTabela();
            
            // Definir datas padrão (últimos 30 dias)
            const hoje = new Date();
            const trintaDiasAtras = new Date();
            trintaDiasAtras.setDate(hoje.getDate() - 30);
            
            const toISODate = (date) => date.toISOString().split('T')[0];

            document.getElementById('dataInicio').value = toISODate(trintaDiasAtras);
            document.getElementById('dataFim').value = toISODate(hoje);
            
            console.log("Sistema inicializado com Bootstrap!");
            verificarDados();
        };
    </script>
</body>
</html>